<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WeEvolve - Owl Companion</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#0D0D2A;color:#e3f98a;font-family:'SF Mono',Menlo,monospace;overflow:hidden;height:100vh;width:100vw}
  #canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}

  /* Stats overlay - bottom left */
  #stats{position:fixed;bottom:20px;left:20px;z-index:10;background:rgba(13,13,42,0.85);
    border:1px solid rgba(227,249,138,0.25);border-radius:12px;padding:16px 20px;
    min-width:260px;backdrop-filter:blur(12px);pointer-events:none}
  #stats h2{font-size:13px;letter-spacing:2px;color:#65cdd8;margin-bottom:10px;text-transform:uppercase}
  .stat-row{display:flex;justify-content:space-between;align-items:center;margin:4px 0;font-size:12px}
  .stat-label{color:#aaa}
  .stat-val{color:#e3f98a;font-weight:bold}

  /* XP Bar */
  .xp-bar-outer{width:100%;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;margin:8px 0}
  .xp-bar-inner{height:100%;background:linear-gradient(90deg,#8533fc,#e3f98a);border-radius:3px;transition:width .6s ease}

  /* SEED Phase */
  .seed-phase{display:flex;gap:4px;margin:8px 0 4px;flex-wrap:wrap}
  .seed-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.12);transition:all .3s}
  .seed-dot.active{background:#e3f98a;box-shadow:0 0 8px #e3f98a}

  /* Skill bars */
  .skill{margin:3px 0}
  .skill-name{font-size:10px;color:#888;display:flex;justify-content:space-between}
  .skill-bar-outer{width:100%;height:3px;background:rgba(255,255,255,0.06);border-radius:2px;margin-top:2px}
  .skill-bar-inner{height:100%;border-radius:2px;transition:width .8s ease}

  /* State indicator - top right */
  #state-indicator{position:fixed;top:20px;right:20px;z-index:10;
    background:rgba(13,13,42,0.85);border:1px solid rgba(101,205,216,0.3);
    border-radius:20px;padding:8px 18px;backdrop-filter:blur(12px);
    display:flex;align-items:center;gap:8px;font-size:13px;pointer-events:none}
  #state-dot{width:8px;height:8px;border-radius:50%;background:#65cdd8;
    box-shadow:0 0 10px #65cdd8;animation:pulse-dot 2s ease infinite}
  @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}

  /* Title */
  #title{position:fixed;top:20px;left:20px;z-index:10;font-size:11px;letter-spacing:3px;
    color:rgba(227,249,138,0.4);text-transform:uppercase;pointer-events:none}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="title">WeEvolve Companion</div>

<div id="state-indicator">
  <span id="state-dot"></span>
  <span id="state-text">Idle</span>
</div>

<div id="stats">
  <h2>Evolution</h2>
  <div class="stat-row"><span class="stat-label">Level</span><span class="stat-val" id="s-level">1</span></div>
  <div class="xp-bar-outer"><div class="xp-bar-inner" id="s-xp" style="width:0%"></div></div>
  <div class="stat-row"><span class="stat-label">Learnings</span><span class="stat-val" id="s-learn">0</span></div>
  <div class="stat-row"><span class="stat-label">Insights</span><span class="stat-val" id="s-insight">0</span></div>
  <div class="stat-row"><span class="stat-label">Alpha</span><span class="stat-val" id="s-alpha">0</span></div>
  <div class="stat-row"><span class="stat-label">Streak</span><span class="stat-val" id="s-streak">0d</span></div>
  <div style="margin-top:10px">
    <div class="stat-row"><span class="stat-label" style="color:#65cdd8">SEED Phase</span></div>
    <div class="seed-phase" id="seed-dots"></div>
  </div>
  <div style="margin-top:10px">
    <div class="stat-row"><span class="stat-label" style="color:#65cdd8">Skills</span></div>
    <div id="skill-bars"></div>
  </div>
</div>

<script type="importmap">
  {"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"}}
</script>
<script type="module">
import * as THREE from 'three';

/* --------------------------------------------------------- */
/* SCENE SETUP                                               */
/* --------------------------------------------------------- */
const canvas = document.getElementById('canvas');
const renderer = new THREE.WebGLRenderer({canvas, antialias: true, alpha: false});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.toneMapping = THREE.ACESFilmicToneMapping;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0D0D2A);
scene.fog = new THREE.FogExp2(0x0D0D2A, 0.06);

const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.set(0, 0.6, 5);

/* Lights */
const ambient = new THREE.AmbientLight(0x334466, 0.6);
scene.add(ambient);
const key = new THREE.DirectionalLight(0xFFD700, 0.9);
key.position.set(3, 5, 4);
scene.add(key);
const rim = new THREE.PointLight(0x65cdd8, 0.8, 15);
rim.position.set(-3, 2, -2);
scene.add(rim);
const fill = new THREE.PointLight(0x8533fc, 0.4, 12);
fill.position.set(2, -1, 3);
scene.add(fill);

/* --------------------------------------------------------- */
/* BUILD OWL                                                 */
/* --------------------------------------------------------- */
const owl = new THREE.Group();

/* Materials */
const bodyMat = new THREE.MeshStandardMaterial({color:0xCD853F, roughness:0.55, metalness:0.3});
const darkMat = new THREE.MeshStandardMaterial({color:0x8B6914, roughness:0.6, metalness:0.2});
const eyeWhiteMat = new THREE.MeshStandardMaterial({color:0xFFFFF0, roughness:0.2, metalness:0.1});
const irisMat = new THREE.MeshStandardMaterial({color:0xFFD700, emissive:0xFFD700, emissiveIntensity:0.4, roughness:0.1, metalness:0.5});
const pupilMat = new THREE.MeshStandardMaterial({color:0x111111, roughness:0.8});
const beakMat = new THREE.MeshStandardMaterial({color:0xDAA520, roughness:0.4, metalness:0.4});
const wingMat = new THREE.MeshStandardMaterial({color:0xA0722A, roughness:0.5, metalness:0.25});
const talonMat = new THREE.MeshStandardMaterial({color:0x8B7355, roughness:0.6, metalness:0.3});

/* Body */
const body = new THREE.Mesh(new THREE.SphereGeometry(0.9, 32, 32), bodyMat);
body.scale.set(1, 1.15, 0.9);
owl.add(body);

/* Head */
const head = new THREE.Mesh(new THREE.SphereGeometry(0.62, 32, 32), bodyMat);
head.position.set(0, 1.1, 0.05);
owl.add(head);

/* Ear tufts */
const earGeo = new THREE.ConeGeometry(0.15, 0.45, 8);
const earL = new THREE.Mesh(earGeo, darkMat);
earL.position.set(-0.32, 1.72, 0);
earL.rotation.z = 0.25;
owl.add(earL);
const earR = new THREE.Mesh(earGeo, darkMat);
earR.position.set(0.32, 1.72, 0);
earR.rotation.z = -0.25;
owl.add(earR);

/* Eye sockets (dark rings) */
const socketGeo = new THREE.SphereGeometry(0.2, 24, 24);
const socketMat = new THREE.MeshStandardMaterial({color:0x3B2610, roughness:0.8});
const socketL = new THREE.Mesh(socketGeo, socketMat);
socketL.position.set(-0.22, 1.18, 0.48);
socketL.scale.set(1, 1, 0.4);
owl.add(socketL);
const socketR = new THREE.Mesh(socketGeo, socketMat);
socketR.position.set(0.22, 1.18, 0.48);
socketR.scale.set(1, 1, 0.4);
owl.add(socketR);

/* Eyes */
function makeEye(x) {
  const g = new THREE.Group();
  const white = new THREE.Mesh(new THREE.SphereGeometry(0.14, 20, 20), eyeWhiteMat);
  g.add(white);
  const iris = new THREE.Mesh(new THREE.SphereGeometry(0.09, 16, 16), irisMat);
  iris.position.z = 0.07;
  g.add(iris);
  const pupil = new THREE.Mesh(new THREE.SphereGeometry(0.045, 12, 12), pupilMat);
  pupil.position.z = 0.12;
  g.add(pupil);
  /* Upper eyelid for blinking */
  const lidGeo = new THREE.SphereGeometry(0.155, 20, 20, 0, Math.PI * 2, 0, Math.PI * 0.5);
  const lidMat = new THREE.MeshStandardMaterial({color:0xCD853F, roughness:0.55, metalness:0.3});
  const lid = new THREE.Mesh(lidGeo, lidMat);
  lid.rotation.x = -Math.PI;
  lid.position.z = 0.01;
  lid.visible = false;
  lid.name = 'lid';
  g.add(lid);
  g.position.set(x, 1.18, 0.52);
  return g;
}
const eyeL = makeEye(-0.22);
const eyeR = makeEye(0.22);
owl.add(eyeL, eyeR);

/* Beak */
const beakGeo = new THREE.ConeGeometry(0.08, 0.18, 6);
const beak = new THREE.Mesh(beakGeo, beakMat);
beak.position.set(0, 1.0, 0.58);
beak.rotation.x = Math.PI;
owl.add(beak);

/* Wings */
function makeWing(side) {
  const shape = new THREE.Shape();
  shape.moveTo(0, 0);
  shape.quadraticCurveTo(0.6 * side, 0.3, 0.9 * side, -0.1);
  shape.quadraticCurveTo(0.7 * side, -0.5, 0.1 * side, -0.7);
  shape.lineTo(0, -0.4);
  const geo = new THREE.ExtrudeGeometry(shape, {depth: 0.06, bevelEnabled: true, bevelThickness: 0.02, bevelSize: 0.02, bevelSegments: 3});
  const wing = new THREE.Mesh(geo, wingMat);
  wing.position.set(side * 0.7, 0.3, -0.1);
  wing.rotation.y = side * -0.3;
  return wing;
}
const wingL = makeWing(-1);
const wingR = makeWing(1);
owl.add(wingL, wingR);

/* Talons */
for (let i = -1; i <= 1; i += 2) {
  for (let j = -1; j <= 1; j++) {
    const talon = new THREE.Mesh(new THREE.CylinderGeometry(0.025, 0.015, 0.2, 8), talonMat);
    talon.position.set(i * 0.25 + j * 0.06, -1.0, 0.1 + Math.abs(j) * 0.05);
    talon.rotation.x = 0.3;
    owl.add(talon);
  }
}

/* Chest feather pattern (v-marks) */
const chestMat = new THREE.MeshStandardMaterial({color:0xDEB887, roughness:0.7, metalness:0.1});
for (let row = 0; row < 4; row++) {
  for (let col = -1; col <= 1; col++) {
    const m = new THREE.Mesh(new THREE.ConeGeometry(0.04, 0.1, 3), chestMat);
    m.position.set(col * 0.15, -0.1 - row * 0.18, 0.82 - row * 0.06);
    m.rotation.x = -0.3;
    owl.add(m);
  }
}

owl.position.y = -0.3;
scene.add(owl);

/* --------------------------------------------------------- */
/* AUDIO VISUALIZATION RING                                  */
/* --------------------------------------------------------- */
const RING_SEGMENTS = 64;
const ringPositions = new Float32Array(RING_SEGMENTS * 3);
const ringGeo = new THREE.BufferGeometry();
ringGeo.setAttribute('position', new THREE.BufferAttribute(ringPositions, 3));
const ringMat = new THREE.LineBasicMaterial({color: 0x65cdd8, linewidth: 1, transparent: true, opacity: 0.7});
const ring = new THREE.LineLoop(ringGeo, ringMat);
ring.position.y = 0.3;
scene.add(ring);

/* Audio setup */
let analyser = null;
let audioData = new Uint8Array(RING_SEGMENTS);

async function initAudio() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
    const ctx = new AudioContext();
    const src = ctx.createMediaStreamSource(stream);
    analyser = ctx.createAnalyser();
    analyser.fftSize = 128;
    analyser.smoothingTimeConstant = 0.8;
    src.connect(analyser);
    audioData = new Uint8Array(analyser.frequencyBinCount);
  } catch (e) {
    /* Microphone not available -- ring shows a gentle idle wave */
  }
}
initAudio();

/* --------------------------------------------------------- */
/* PARTICLE FIELD (ambient sparkles)                         */
/* --------------------------------------------------------- */
const PARTICLE_COUNT = 200;
const particleGeo = new THREE.BufferGeometry();
const particlePos = new Float32Array(PARTICLE_COUNT * 3);
const particleSizes = new Float32Array(PARTICLE_COUNT);
for (let i = 0; i < PARTICLE_COUNT; i++) {
  particlePos[i*3]   = (Math.random()-0.5)*12;
  particlePos[i*3+1] = (Math.random()-0.5)*8;
  particlePos[i*3+2] = (Math.random()-0.5)*8 - 2;
  particleSizes[i]   = Math.random()*2+0.5;
}
particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));
particleGeo.setAttribute('size', new THREE.BufferAttribute(particleSizes, 1));
const particleMat = new THREE.PointsMaterial({color:0xe3f98a, size:0.03, transparent:true, opacity:0.35, sizeAttenuation:true});
const particles = new THREE.Points(particleGeo, particleMat);
scene.add(particles);

/* --------------------------------------------------------- */
/* STATE                                                     */
/* --------------------------------------------------------- */
let owlState = 'idle';
let blinkTimer = 0;
let blinkDuration = 0;
let isBlinking = false;
let nextBlinkIn = 2 + Math.random() * 4;

const SEED_NAMES = ['PERCEIVE','CONNECT','LEARN','QUESTION','EXPAND','SHARE','RECEIVE','IMPROVE'];
let currentSeedPhase = 0;

/* --------------------------------------------------------- */
/* UI UPDATES                                                */
/* --------------------------------------------------------- */
const seedDotsEl = document.getElementById('seed-dots');
SEED_NAMES.forEach((name, i) => {
  const dot = document.createElement('div');
  dot.className = 'seed-dot';
  dot.title = name;
  if (i === 0) dot.classList.add('active');
  seedDotsEl.appendChild(dot);
});

const SKILL_COLORS = ['#e3f98a','#65cdd8','#8533fc','#FFD700','#ff6b6b'];

function updateUI(data) {
  document.getElementById('s-level').textContent = data.level || 1;
  const pct = data.xp_to_next ? Math.min(100, ((data.xp || 0) / data.xp_to_next) * 100) : 0;
  document.getElementById('s-xp').style.width = pct + '%';
  document.getElementById('s-learn').textContent = data.total_learnings || 0;
  document.getElementById('s-insight').textContent = data.total_insights || 0;
  document.getElementById('s-alpha').textContent = data.total_alpha || 0;
  document.getElementById('s-streak').textContent = (data.streak_days || 0) + 'd';

  /* Top 5 skills */
  const skills = data.skills || {};
  const sorted = Object.entries(skills).sort((a,b) => b[1]-a[1]).slice(0,5);
  const container = document.getElementById('skill-bars');
  container.innerHTML = '';
  sorted.forEach(([name, val], i) => {
    const maxVal = Math.max(1, ...Object.values(skills));
    const pct = (val / maxVal) * 100;
    const d = document.createElement('div');
    d.className = 'skill';
    d.innerHTML = `<div class="skill-name"><span>${name}</span><span>${val.toFixed(1)}</span></div>
      <div class="skill-bar-outer"><div class="skill-bar-inner" style="width:${pct}%;background:${SKILL_COLORS[i%5]}"></div></div>`;
    container.appendChild(d);
  });
}

function updateStateUI(state) {
  owlState = state;
  const dot = document.getElementById('state-dot');
  const text = document.getElementById('state-text');
  const colors = {idle:'#65cdd8', listening:'#e3f98a', speaking:'#FFD700', thinking:'#8533fc', celebrating:'#ff6b6b'};
  dot.style.background = colors[state] || '#65cdd8';
  dot.style.boxShadow = `0 0 10px ${colors[state] || '#65cdd8'}`;
  text.textContent = state.charAt(0).toUpperCase() + state.slice(1);
}

/* Fetch stats + state periodically */
async function pollServer() {
  try {
    const [statsRes, stateRes] = await Promise.all([
      fetch('/api/stats').then(r => r.ok ? r.json() : null),
      fetch('/api/state').then(r => r.ok ? r.json() : null),
    ]);
    if (statsRes) updateUI(statsRes);
    if (stateRes) {
      updateStateUI(stateRes.state || 'idle');
      const pi = SEED_NAMES.indexOf(stateRes.seed_phase);
      if (pi >= 0) {
        currentSeedPhase = pi;
        seedDotsEl.querySelectorAll('.seed-dot').forEach((d, i) => d.classList.toggle('active', i === pi));
      }
    }
  } catch (e) { /* server unreachable -- ignore */ }
}
pollServer();
setInterval(pollServer, 3000);

/* --------------------------------------------------------- */
/* ANIMATION LOOP                                            */
/* --------------------------------------------------------- */
const clock = new THREE.Clock();

function animate() {
  requestAnimationFrame(animate);
  const t = clock.getElapsedTime();
  const dt = clock.getDelta();

  /* ---- Breathing (always) ---- */
  const breathe = Math.sin(t * 1.2) * 0.015;
  owl.position.y = -0.3 + breathe;
  body.scale.y = 1.15 + Math.sin(t * 1.2) * 0.02;
  body.scale.x = 1.0 - Math.sin(t * 1.2) * 0.008;

  /* ---- Blinking ---- */
  nextBlinkIn -= (1/60);
  if (nextBlinkIn <= 0 && !isBlinking) {
    isBlinking = true;
    blinkDuration = 0;
    eyeL.children.find(c=>c.name==='lid').visible = true;
    eyeR.children.find(c=>c.name==='lid').visible = true;
  }
  if (isBlinking) {
    blinkDuration += (1/60);
    if (blinkDuration > 0.15) {
      isBlinking = false;
      nextBlinkIn = 2 + Math.random() * 5;
      eyeL.children.find(c=>c.name==='lid').visible = false;
      eyeR.children.find(c=>c.name==='lid').visible = false;
    }
  }

  /* ---- State-dependent animations ---- */
  if (owlState === 'listening') {
    /* Gentle head tilt */
    head.rotation.z = Math.sin(t * 0.8) * 0.12;
    head.rotation.x = Math.sin(t * 0.5) * 0.05;
    earL.rotation.z = 0.25 + Math.sin(t * 2) * 0.08;
    earR.rotation.z = -0.25 - Math.sin(t * 2) * 0.08;
  } else {
    head.rotation.z *= 0.95;
    head.rotation.x *= 0.95;
    earL.rotation.z += (0.25 - earL.rotation.z) * 0.05;
    earR.rotation.z += (-0.25 - earR.rotation.z) * 0.05;
  }

  if (owlState === 'speaking') {
    /* Eye glow pulse */
    irisMat.emissiveIntensity = 0.4 + Math.sin(t * 6) * 0.35;
    /* Beak open/close */
    beak.scale.y = 1.0 + Math.sin(t * 8) * 0.3;
    beak.position.y = 1.0 - Math.sin(t * 8) * 0.015;
  } else {
    irisMat.emissiveIntensity += (0.4 - irisMat.emissiveIntensity) * 0.05;
    beak.scale.y += (1.0 - beak.scale.y) * 0.1;
  }

  if (owlState === 'thinking') {
    /* Slow rotation and upward gaze */
    owl.rotation.y = Math.sin(t * 0.3) * 0.15;
    head.rotation.x = -0.1 + Math.sin(t * 0.7) * 0.05;
    irisMat.emissiveIntensity = 0.6 + Math.sin(t * 2) * 0.2;
  } else if (owlState !== 'listening') {
    owl.rotation.y *= 0.97;
  }

  if (owlState === 'celebrating') {
    /* Wing flap */
    wingL.rotation.z = Math.sin(t * 8) * 0.4;
    wingR.rotation.z = -Math.sin(t * 8) * 0.4;
    wingL.position.y = 0.3 + Math.abs(Math.sin(t * 8)) * 0.15;
    wingR.position.y = 0.3 + Math.abs(Math.sin(t * 8)) * 0.15;
    /* Bounce */
    owl.position.y = -0.3 + Math.abs(Math.sin(t * 4)) * 0.15;
  } else {
    wingL.rotation.z *= 0.93;
    wingR.rotation.z *= 0.93;
    wingL.position.y += (0.3 - wingL.position.y) * 0.05;
    wingR.position.y += (0.3 - wingR.position.y) * 0.05;
  }

  /* Idle subtle sway */
  if (owlState === 'idle') {
    owl.rotation.y = Math.sin(t * 0.2) * 0.04;
    head.rotation.z = Math.sin(t * 0.4) * 0.02;
  }

  /* ---- Audio ring ---- */
  if (analyser) {
    analyser.getByteFrequencyData(audioData);
  }
  const baseRadius = 2.0;
  const posArr = ring.geometry.attributes.position.array;
  for (let i = 0; i < RING_SEGMENTS; i++) {
    const angle = (i / RING_SEGMENTS) * Math.PI * 2;
    const audioIdx = Math.floor((i / RING_SEGMENTS) * audioData.length);
    const audioVal = (audioData[audioIdx] || 0) / 255;
    const idleWave = Math.sin(t * 2 + angle * 3) * 0.03 + Math.sin(t * 0.7 + angle * 7) * 0.02;
    const r = baseRadius + audioVal * 0.5 + idleWave;
    posArr[i*3]   = Math.cos(angle) * r;
    posArr[i*3+1] = Math.sin(angle) * r;
    posArr[i*3+2] = 0;
  }
  ring.geometry.attributes.position.needsUpdate = true;

  /* Ring color intensity from audio */
  const avg = audioData.reduce((a,b) => a+b, 0) / audioData.length / 255;
  ringMat.opacity = 0.3 + avg * 0.6;
  const hue = 0.5 + avg * 0.1;
  ringMat.color.setHSL(hue, 0.7, 0.5 + avg * 0.3);

  /* ---- Particles drift ---- */
  const pp = particles.geometry.attributes.position.array;
  for (let i = 0; i < PARTICLE_COUNT; i++) {
    pp[i*3+1] += 0.002;
    if (pp[i*3+1] > 4) pp[i*3+1] = -4;
  }
  particles.geometry.attributes.position.needsUpdate = true;
  particleMat.opacity = 0.2 + Math.sin(t * 0.5) * 0.1;

  /* ---- Camera gentle sway ---- */
  camera.position.x = Math.sin(t * 0.15) * 0.2;
  camera.position.y = 0.6 + Math.sin(t * 0.1) * 0.1;
  camera.lookAt(0, 0.4, 0);

  renderer.render(scene, camera);
}
animate();

/* Resize */
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
