<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0D0D2A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>8OWLS Companion</title>
<link rel="manifest" href="/manifest.json">
<style>
  /* ========================================
     8OWLS COMPANION — CSS-ONLY OWL
     Brand: #0D0D2A (dark), #e3f98a (lime), #8533fc (purple), #65cdd8 (teal)
     ======================================== */

  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0D0D2A;
    --bg-card: rgba(13, 13, 42, 0.85);
    --lime: #e3f98a;
    --purple: #8533fc;
    --teal: #65cdd8;
    --gold: #FFD700;
    --danger: #ff6b6b;
    --text: #e8e8f0;
    --text-dim: #888;
    --border: rgba(227, 249, 138, 0.15);
  }

  html, body {
    height: 100%; width: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    overflow: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
  }

  /* ---- BACKGROUND PARTICLES (CSS-only) ---- */
  .bg-particles {
    position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none;
  }
  .bg-particles span {
    position: absolute;
    width: 2px; height: 2px;
    background: var(--lime);
    border-radius: 50%;
    opacity: 0;
    animation: float-up linear infinite;
  }
  @keyframes float-up {
    0%   { opacity: 0; transform: translateY(0) scale(1); }
    10%  { opacity: 0.4; }
    90%  { opacity: 0.1; }
    100% { opacity: 0; transform: translateY(-100vh) scale(0.3); }
  }

  /* ---- HEADER ---- */
  .header {
    position: relative; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 24px;
    flex-shrink: 0;
  }
  .header-title {
    font-size: 11px; letter-spacing: 3px; text-transform: uppercase;
    color: rgba(227, 249, 138, 0.5);
    font-weight: 500;
  }
  .state-badge {
    display: flex; align-items: center; gap: 8px;
    background: var(--bg-card);
    border: 1px solid rgba(101, 205, 216, 0.3);
    border-radius: 20px; padding: 6px 16px;
    backdrop-filter: blur(12px);
    font-size: 13px; font-weight: 400;
  }
  .state-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--teal);
    box-shadow: 0 0 10px var(--teal);
    animation: pulse-dot 2s ease infinite;
  }
  @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* ---- MAIN AREA ---- */
  .main {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative; z-index: 5;
    min-height: 0;
    padding: 0 20px;
  }

  /* ---- OWL CONTAINER ---- */
  .owl-container {
    position: relative;
    width: 280px; height: 280px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  /* ---- PULSING RING ---- */
  .owl-ring {
    position: absolute; inset: -20px;
    border-radius: 50%;
    border: 1.5px solid rgba(101, 205, 216, 0.3);
    animation: ring-breathe 4s ease-in-out infinite;
  }
  .owl-ring::after {
    content: '';
    position: absolute; inset: -12px;
    border-radius: 50%;
    border: 1px solid rgba(133, 51, 252, 0.15);
    animation: ring-breathe 4s ease-in-out infinite 0.5s;
  }
  @keyframes ring-breathe {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50%      { transform: scale(1.06); opacity: 0.9; }
  }
  .owl-ring.speaking {
    animation: ring-speak 0.6s ease-in-out infinite;
    border-color: rgba(227, 249, 138, 0.5);
  }
  .owl-ring.speaking::after {
    animation: ring-speak 0.6s ease-in-out infinite 0.15s;
    border-color: rgba(227, 249, 138, 0.25);
  }
  @keyframes ring-speak {
    0%, 100% { transform: scale(1); opacity: 0.6; }
    50%      { transform: scale(1.12); opacity: 1; }
  }
  .owl-ring.listening {
    animation: ring-listen 1.5s ease-in-out infinite;
    border-color: rgba(133, 51, 252, 0.5);
  }
  .owl-ring.listening::after {
    animation: ring-listen 1.5s ease-in-out infinite 0.3s;
    border-color: rgba(133, 51, 252, 0.25);
  }
  @keyframes ring-listen {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50%      { transform: scale(1.08); opacity: 1; }
  }

  /* ---- THE OWL (CSS) ---- */
  .owl {
    position: relative;
    font-size: 140px;
    line-height: 1;
    animation: owl-breathe 4s ease-in-out infinite;
    filter: drop-shadow(0 0 40px rgba(133, 51, 252, 0.3))
            drop-shadow(0 0 80px rgba(101, 205, 216, 0.15));
    cursor: default;
    user-select: none;
    transition: filter 0.4s ease;
    z-index: 2;
  }
  .owl:hover {
    filter: drop-shadow(0 0 50px rgba(133, 51, 252, 0.5))
            drop-shadow(0 0 100px rgba(227, 249, 138, 0.2));
  }
  @keyframes owl-breathe {
    0%, 100% { transform: scale(1) translateY(0); }
    50%      { transform: scale(1.04) translateY(-4px); }
  }
  .owl.speaking {
    animation: owl-speak 0.3s ease-in-out infinite;
    filter: drop-shadow(0 0 50px rgba(227, 249, 138, 0.5))
            drop-shadow(0 0 100px rgba(227, 249, 138, 0.2));
  }
  @keyframes owl-speak {
    0%, 100% { transform: scale(1.02) translateY(-2px); }
    50%      { transform: scale(1.06) translateY(-6px); }
  }
  .owl.thinking {
    animation: owl-think 2s ease-in-out infinite;
    filter: drop-shadow(0 0 50px rgba(133, 51, 252, 0.6))
            drop-shadow(0 0 100px rgba(133, 51, 252, 0.3));
  }
  @keyframes owl-think {
    0%, 100% { transform: scale(1) translateY(0) rotate(0deg); }
    25%      { transform: scale(1.02) translateY(-3px) rotate(-2deg); }
    75%      { transform: scale(1.02) translateY(-3px) rotate(2deg); }
  }
  .owl.celebrating {
    animation: owl-celebrate 0.5s ease-in-out infinite;
    filter: drop-shadow(0 0 60px rgba(255, 215, 0, 0.5))
            drop-shadow(0 0 120px rgba(227, 249, 138, 0.3));
  }
  @keyframes owl-celebrate {
    0%, 100% { transform: scale(1) translateY(0) rotate(0deg); }
    25%      { transform: scale(1.08) translateY(-10px) rotate(-5deg); }
    75%      { transform: scale(1.08) translateY(-10px) rotate(5deg); }
  }

  /* ---- GLOW BACKDROP ---- */
  .owl-glow {
    position: absolute;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(133,51,252,0.2) 0%, transparent 70%);
    animation: glow-pulse 4s ease-in-out infinite;
    z-index: 1;
  }
  @keyframes glow-pulse {
    0%, 100% { opacity: 0.5; transform: scale(1); }
    50%      { opacity: 1; transform: scale(1.15); }
  }

  /* ---- SEED PHASE RING ---- */
  .seed-ring {
    position: absolute; inset: -50px;
    z-index: 0;
  }
  .seed-phase-dot {
    position: absolute;
    width: 32px; height: 32px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
    background: rgba(13, 13, 42, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    font-size: 7px; font-weight: 600;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    transition: all 0.4s ease;
    cursor: default;
  }
  .seed-phase-dot.active {
    color: var(--lime);
    border-color: rgba(227, 249, 138, 0.4);
    background: rgba(227, 249, 138, 0.08);
    box-shadow: 0 0 12px rgba(227, 249, 138, 0.2);
  }
  .seed-phase-dot:nth-child(1) { top: -8px;  left: 50%; transform: translateX(-50%); }
  .seed-phase-dot:nth-child(2) { top: 12%;   right: -2px; }
  .seed-phase-dot:nth-child(3) { top: 50%;   right: -14px; transform: translateY(-50%); }
  .seed-phase-dot:nth-child(4) { bottom: 12%; right: -2px; }
  .seed-phase-dot:nth-child(5) { bottom: -8px; left: 50%; transform: translateX(-50%); }
  .seed-phase-dot:nth-child(6) { bottom: 12%; left: -2px; }
  .seed-phase-dot:nth-child(7) { top: 50%;   left: -14px; transform: translateY(-50%); }
  .seed-phase-dot:nth-child(8) { top: 12%;   left: -2px; }

  /* ---- STATS CARD (bottom left) ---- */
  .stats-card {
    position: fixed; bottom: 80px; left: 20px; z-index: 20;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px 20px;
    min-width: 220px;
    backdrop-filter: blur(16px);
    font-size: 12px;
  }
  .stats-card h3 {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--teal); margin-bottom: 10px; font-weight: 500;
  }
  .stat-row {
    display: flex; justify-content: space-between; align-items: center;
    margin: 4px 0;
  }
  .stat-label { color: var(--text-dim); font-weight: 300; }
  .stat-val { color: var(--lime); font-weight: 600; font-variant-numeric: tabular-nums; }

  .xp-bar {
    width: 100%; height: 4px;
    background: rgba(255,255,255,0.06);
    border-radius: 2px; margin: 8px 0;
    overflow: hidden;
  }
  .xp-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--purple), var(--lime));
    border-radius: 2px;
    transition: width 0.6s ease;
  }

  .skill-row {
    margin: 3px 0;
  }
  .skill-header {
    display: flex; justify-content: space-between;
    font-size: 10px; color: var(--text-dim); font-weight: 300;
  }
  .skill-bar {
    width: 100%; height: 2px;
    background: rgba(255,255,255,0.04);
    border-radius: 1px; margin-top: 2px;
    overflow: hidden;
  }
  .skill-fill {
    height: 100%; border-radius: 1px;
    transition: width 0.8s ease;
  }

  /* ---- CHAT AREA ---- */
  .chat-area {
    position: relative; z-index: 20;
    flex-shrink: 0;
    padding: 0 20px 20px;
    width: 100%;
    max-width: 680px;
    margin: 0 auto;
  }

  .chat-messages {
    max-height: 140px;
    overflow-y: auto;
    margin-bottom: 12px;
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.1) transparent;
  }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

  .chat-msg {
    padding: 8px 14px;
    border-radius: 12px;
    margin-bottom: 6px;
    font-size: 13px;
    line-height: 1.5;
    animation: msg-in 0.3s ease;
    max-width: 85%;
    word-wrap: break-word;
  }
  @keyframes msg-in {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .chat-msg.user {
    background: rgba(133, 51, 252, 0.15);
    border: 1px solid rgba(133, 51, 252, 0.2);
    margin-left: auto;
    color: var(--text);
  }
  .chat-msg.owl {
    background: rgba(101, 205, 216, 0.08);
    border: 1px solid rgba(101, 205, 216, 0.15);
    color: var(--text);
  }
  .chat-msg.owl .owl-label {
    font-size: 10px; color: var(--teal); font-weight: 500;
    letter-spacing: 1px; text-transform: uppercase;
    margin-bottom: 2px;
  }
  .chat-msg.system {
    background: rgba(227, 249, 138, 0.05);
    border: 1px solid rgba(227, 249, 138, 0.1);
    color: var(--text-dim);
    font-size: 11px;
    text-align: center;
    max-width: 100%;
  }

  .chat-input-row {
    display: flex; gap: 8px; align-items: center;
  }
  .chat-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--text);
    font-family: inherit;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .chat-input::placeholder { color: rgba(255,255,255,0.25); }
  .chat-input:focus {
    border-color: rgba(133, 51, 252, 0.4);
    box-shadow: 0 0 0 3px rgba(133, 51, 252, 0.1);
  }
  .chat-send {
    width: 44px; height: 44px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--purple), #6b2fd6);
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.15s, opacity 0.2s;
    flex-shrink: 0;
  }
  .chat-send:hover { transform: scale(1.05); }
  .chat-send:active { transform: scale(0.95); }
  .chat-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .chat-send svg { width: 20px; height: 20px; }

  /* ---- TYPING INDICATOR ---- */
  .typing-dots {
    display: inline-flex; gap: 4px; padding: 4px 0;
  }
  .typing-dots span {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--teal); opacity: 0.4;
    animation: typing-bounce 1.2s ease-in-out infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typing-bounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  /* ---- RESPONSIVE ---- */
  @media (max-height: 700px) {
    .owl-container { width: 200px; height: 200px; }
    .owl { font-size: 100px; }
    .owl-glow { width: 140px; height: 140px; }
    .seed-ring { inset: -40px; }
    .seed-phase-dot { width: 26px; height: 26px; font-size: 6px; }
    .stats-card { display: none; }
    .chat-messages { max-height: 100px; }
  }
  @media (max-width: 480px) {
    .stats-card { display: none; }
    .owl-container { width: 220px; height: 220px; }
    .owl { font-size: 110px; }
  }
</style>
</head>
<body>

<!-- Background particles -->
<div class="bg-particles" id="particles"></div>

<!-- Header -->
<div class="header">
  <div class="header-title">8OWLS Companion</div>
  <div class="state-badge">
    <span class="state-dot" id="state-dot"></span>
    <span id="state-text">Idle</span>
  </div>
</div>

<!-- Main content area with owl -->
<div class="main">
  <div class="owl-container">
    <!-- SEED phase indicators around the owl -->
    <div class="seed-ring" id="seed-ring"></div>
    <!-- Glow backdrop -->
    <div class="owl-glow"></div>
    <!-- Pulsing ring -->
    <div class="owl-ring" id="owl-ring"></div>
    <!-- The Owl -->
    <div class="owl" id="owl" role="img" aria-label="Owl companion">&#x1F989;</div>
  </div>
</div>

<!-- Stats overlay -->
<div class="stats-card" id="stats-card">
  <h3>Evolution</h3>
  <div class="stat-row">
    <span class="stat-label">Level</span>
    <span class="stat-val" id="s-level">1</span>
  </div>
  <div class="xp-bar"><div class="xp-fill" id="s-xp" style="width:0%"></div></div>
  <div class="stat-row">
    <span class="stat-label">Learnings</span>
    <span class="stat-val" id="s-learn">0</span>
  </div>
  <div class="stat-row">
    <span class="stat-label">Insights</span>
    <span class="stat-val" id="s-insight">0</span>
  </div>
  <div class="stat-row">
    <span class="stat-label">Alpha</span>
    <span class="stat-val" id="s-alpha">0</span>
  </div>
  <div class="stat-row">
    <span class="stat-label">Streak</span>
    <span class="stat-val" id="s-streak">0d</span>
  </div>
  <div id="skill-bars" style="margin-top: 8px;"></div>
</div>

<!-- Chat area -->
<div class="chat-area">
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-row">
    <input
      type="text"
      class="chat-input"
      id="chat-input"
      placeholder="Ask your owl anything..."
      autocomplete="off"
      maxlength="2000"
    >
    <button class="chat-send" id="chat-send" title="Send">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>
</div>

<script>
/* ================================================================
   8OWLS COMPANION — Runtime
   ================================================================ */

const SEED_PHASES = ['PERCEIVE','CONNECT','LEARN','QUESTION','EXPAND','SHARE','RECEIVE','IMPROVE'];
const SKILL_COLORS = ['#e3f98a','#65cdd8','#8533fc','#FFD700','#ff6b6b','#6BCB77','#ff9f43','#a29bfe'];
const STATE_COLORS = {
  idle: '#65cdd8', listening: '#8533fc', speaking: '#e3f98a',
  thinking: '#8533fc', celebrating: '#FFD700'
};

let currentState = 'idle';
let currentSeedPhase = 0;
let chatHistory = [];
let isSending = false;

/* ---- Background particles ---- */
(function initParticles() {
  const container = document.getElementById('particles');
  const count = 30;
  for (let i = 0; i < count; i++) {
    const span = document.createElement('span');
    span.style.left = (Math.random() * 100) + '%';
    span.style.top = (60 + Math.random() * 50) + '%';
    span.style.width = (1 + Math.random() * 2) + 'px';
    span.style.height = span.style.width;
    span.style.animationDuration = (8 + Math.random() * 16) + 's';
    span.style.animationDelay = (Math.random() * 10) + 's';
    container.appendChild(span);
  }
})();

/* ---- SEED Phase dots around owl ---- */
(function initSeedRing() {
  const ring = document.getElementById('seed-ring');
  SEED_PHASES.forEach((phase, i) => {
    const dot = document.createElement('div');
    dot.className = 'seed-phase-dot' + (i === 0 ? ' active' : '');
    dot.textContent = phase.substring(0, 3);
    dot.title = phase;
    ring.appendChild(dot);
  });
})();

/* ---- State management ---- */
function setOwlState(state) {
  if (state === currentState) return;
  currentState = state;

  const owl = document.getElementById('owl');
  const ring = document.getElementById('owl-ring');
  const dot = document.getElementById('state-dot');
  const text = document.getElementById('state-text');

  owl.className = 'owl' + (state !== 'idle' ? ' ' + state : '');
  ring.className = 'owl-ring' + (state !== 'idle' ? ' ' + state : '');

  const color = STATE_COLORS[state] || '#65cdd8';
  dot.style.background = color;
  dot.style.boxShadow = '0 0 10px ' + color;
  text.textContent = state.charAt(0).toUpperCase() + state.slice(1);
}

function setSeedPhase(idx) {
  if (idx < 0 || idx >= SEED_PHASES.length) return;
  currentSeedPhase = idx;
  document.querySelectorAll('.seed-phase-dot').forEach(function(d, i) {
    d.classList.toggle('active', i === idx);
  });
}

/* ---- Stats update ---- */
function updateStats(data) {
  document.getElementById('s-level').textContent = data.level || 1;
  var pct = data.xp_to_next ? Math.min(100, ((data.xp || 0) / data.xp_to_next) * 100) : 0;
  document.getElementById('s-xp').style.width = pct + '%';
  document.getElementById('s-learn').textContent = data.total_learnings || 0;
  document.getElementById('s-insight').textContent = data.total_insights || 0;
  document.getElementById('s-alpha').textContent = data.total_alpha || 0;
  document.getElementById('s-streak').textContent = (data.streak_days || 0) + 'd';

  var skills = data.skills || {};
  var sorted = Object.entries(skills).filter(function(e) { return e[1] > 0; })
    .sort(function(a, b) { return b[1] - a[1]; }).slice(0, 5);
  var container = document.getElementById('skill-bars');
  container.innerHTML = '';
  var maxVal = sorted.length > 0 ? Math.max(1, sorted[0][1]) : 1;
  sorted.forEach(function(entry, i) {
    var name = entry[0], val = entry[1];
    var pct = (val / maxVal) * 100;
    var div = document.createElement('div');
    div.className = 'skill-row';
    div.innerHTML = '<div class="skill-header"><span>' + name + '</span><span>' + val.toFixed(1) + '</span></div>'
      + '<div class="skill-bar"><div class="skill-fill" style="width:' + pct + '%;background:' + SKILL_COLORS[i % SKILL_COLORS.length] + '"></div></div>';
    container.appendChild(div);
  });
}

/* ---- Polling ---- */
async function pollServer() {
  try {
    var responses = await Promise.all([
      fetch('/api/stats').then(function(r) { return r.ok ? r.json() : null; }),
      fetch('/api/state').then(function(r) { return r.ok ? r.json() : null; })
    ]);
    if (responses[0]) updateStats(responses[0]);
    if (responses[1]) {
      if (!isSending) setOwlState(responses[1].state || 'idle');
      var pi = SEED_PHASES.indexOf(responses[1].seed_phase);
      if (pi >= 0) setSeedPhase(pi);
    }
  } catch (e) { /* ignore */ }
}
pollServer();
setInterval(pollServer, 3000);

/* ---- Chat system ---- */
var messagesEl = document.getElementById('chat-messages');
var inputEl = document.getElementById('chat-input');
var sendBtn = document.getElementById('chat-send');

function addMessage(type, text) {
  var div = document.createElement('div');
  div.className = 'chat-msg ' + type;
  if (type === 'owl') {
    div.innerHTML = '<div class="owl-label">SOWL</div>' + escapeHtml(text);
  } else if (type === 'system') {
    div.textContent = text;
  } else {
    div.textContent = text;
  }
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return div;
}

function addTypingIndicator() {
  var div = document.createElement('div');
  div.className = 'chat-msg owl';
  div.id = 'typing-indicator';
  div.innerHTML = '<div class="owl-label">SOWL</div><div class="typing-dots"><span></span><span></span><span></span></div>';
  messagesEl.appendChild(div);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return div;
}

function removeTypingIndicator() {
  var el = document.getElementById('typing-indicator');
  if (el) el.remove();
}

function escapeHtml(text) {
  var div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function sendMessage() {
  var text = inputEl.value.trim();
  if (!text || isSending) return;

  isSending = true;
  sendBtn.disabled = true;
  inputEl.value = '';

  addMessage('user', text);
  chatHistory.push({ role: 'user', content: text });

  setOwlState('thinking');
  addTypingIndicator();

  try {
    var response = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: text,
        history: chatHistory.slice(-10)
      })
    });

    removeTypingIndicator();

    if (response.ok) {
      var data = await response.json();
      var reply = data.reply || 'I hear you. Let me think on that.';
      setOwlState('speaking');
      addMessage('owl', reply);
      chatHistory.push({ role: 'assistant', content: reply });

      /* Return to idle after a moment */
      setTimeout(function() { setOwlState('idle'); }, 2000);
    } else {
      var errData = await response.json().catch(function() { return {}; });
      if (errData.error && errData.error.indexOf('API key') >= 0) {
        addMessage('system', 'Set ANTHROPIC_API_KEY to enable chat. The owl can still keep you company.');
      } else {
        addMessage('system', 'Could not reach the owl. Try again.');
      }
      setOwlState('idle');
    }
  } catch (e) {
    removeTypingIndicator();
    addMessage('system', 'Connection lost. The owl is still here.');
    setOwlState('idle');
  } finally {
    isSending = false;
    sendBtn.disabled = false;
    inputEl.focus();
  }
}

sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

/* ---- Initial greeting ---- */
addMessage('owl', 'Hey. I am here. Ask me anything, or just sit with me.');

/* ---- Focus input on load ---- */
setTimeout(function() { inputEl.focus(); }, 500);

/* ---- Audio visualization (optional, enhances ring) ---- */
(async function initAudio() {
  try {
    var stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    var ctx = new AudioContext();
    var src = ctx.createMediaStreamSource(stream);
    var analyser = ctx.createAnalyser();
    analyser.fftSize = 64;
    analyser.smoothingTimeConstant = 0.85;
    src.connect(analyser);
    var data = new Uint8Array(analyser.frequencyBinCount);

    var ring = document.getElementById('owl-ring');
    function updateAudio() {
      analyser.getByteFrequencyData(data);
      var avg = 0;
      for (var i = 0; i < data.length; i++) avg += data[i];
      avg = avg / data.length / 255;

      /* Scale ring border based on audio level */
      if (avg > 0.05) {
        var scale = 1 + avg * 0.08;
        ring.style.transform = 'scale(' + scale + ')';
        ring.style.borderColor = 'rgba(227, 249, 138, ' + (0.3 + avg * 0.5) + ')';
      } else {
        ring.style.transform = '';
        ring.style.borderColor = '';
      }
      requestAnimationFrame(updateAudio);
    }
    updateAudio();
  } catch (e) {
    /* No microphone -- that is fine, ring still animates via CSS */
  }
})();

</script>
</body>
</html>
